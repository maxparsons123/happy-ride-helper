[general]
static=yes
writeprotect=no

; ═══════════════════════════════════════════════════════════════════════════════
; TAXI-INBOUND: WhatsApp and external calls to Ada AI
; 
; CRITICAL: Both read AND write formats must be slin16 BEFORE Answer()
; to ensure AudioSocket negotiates 16kHz from the start.
; If Asterisk interprets 320B frames as 20ms of 8kHz (instead of 10ms of 16kHz),
; Ada will sound SLOW (half-speed, deep voice).
; ═══════════════════════════════════════════════════════════════════════════════
[from-whatsapp]
exten => _+X.,1,NoOp(Incoming WhatsApp Call from: ${CALLERID(num)})
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 ; Force 16kHz slin16 format BEFORE Answer() so AudioSocket uses wideband
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,Set(CHANNEL(read_format)=slin16)
 same => n,Set(CHANNEL(write_format)=slin16)
 same => n,Answer()
 same => n,Wait(0.3)
 ; Generate UUID from phone number (last 12 digits)
 same => n,Set(CLEAN_NR=${FILTER(0-9,${CALLERID(num)})})
 same => n,Set(PADDED_NR=000000000000${CLEAN_NR})
 same => n,Set(SHORT_NR=${PADDED_NR:-12})
 same => n,Set(MY_UUID=00000000-0000-0000-0000-${SHORT_NR})
 same => n,NoOp(Connecting to Bridge with UUID: ${MY_UUID})
 same => n,AudioSocket(${MY_UUID},127.0.0.1:9092)
 same => n,Hangup()

[from-internal]
exten => 100,1,NoOp(Test Call to AI Bridge)
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,Set(CHANNEL(read_format)=slin16)
 same => n,Set(CHANNEL(write_format)=slin16)
 same => n,Answer()
 same => n,AudioSocket(00000000-0000-0000-0000-000000000100,127.0.0.1:9092)
 same => n,Hangup()

[handler]
exten => cleanup,1,NoOp(Cleaning up call)
 same => n,Return()
