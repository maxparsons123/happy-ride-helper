; =============================================================================
; Taxi AI - Asterisk Extensions Configuration
; Compatible with Asterisk 20.6+
; =============================================================================

[general]
static=yes
writeprotect=no

; =============================================================================
; INCOMING WHATSAPP/META CALLS - Forward to C# SipAdaBridge
; =============================================================================
[from-whatsapp]
exten => _+X.,1,NoOp(Incoming WhatsApp Call from: ${CALLERID(num)})
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 same => n,Answer()
 same => n,Progress()
 same => n,Wait(1)
 
 ; Forward to C# SipAdaBridge registered at max201@max.m1online.net
 ; The C# app will answer and connect caller to Ada AI
 same => n,NoOp(Forwarding to SipAdaBridge: max201@max.m1online.net)
 same => n,Dial(SIP/max201@max.m1online.net,60,tT)
 
 ; Fallback if SIP fails - use Python bridge directly
 same => n,NoOp(SIP failed, falling back to AudioSocket bridge)
 same => n,Set(CLEAN_NR=${FILTER(0-9,${CALLERID(num)})})
 same => n,Set(SHORT_NR=${CLEAN_NR:-12})
 same => n,Set(MY_UUID=00000000000000000000${SHORT_NR})
 same => n,AudioSocket(${MY_UUID},127.0.0.1:9092)
 same => n,Hangup()

; =============================================================================
; HANGUP HANDLER
; =============================================================================
[handler]
exten => cleanup,1,NoOp(Cleaning up call)
 same => n,Return()

; =============================================================================
; INTERNAL TEST CALLS (Dial 100 from SIP phone)
; =============================================================================
[from-internal]
exten => 100,1,NoOp(Internal Test Call to Ada)
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 same => n,Answer()
 same => n,Progress()
 same => n,Wait(1)
 same => n,Dial(SIP/max201@max.m1online.net,60,tT)
 same => n,Hangup()