; =============================================================================
; Taxi AI - Asterisk Extensions Configuration
; Routes WhatsApp calls to Python AudioSocket bridge
; Country-specific ring tones for authentic caller experience
; Monitor mode: rings your SIP phone so you can hear the AI conversation
; Uses Opus codec for best quality (WhatsApp native format)
; =============================================================================

[general]
static=yes
writeprotect=no

; =============================================================================
; COUNTRY-SPECIFIC RING TONE DEFINITIONS
; Format: frequency1+frequency2/on-time,frequency/off-time (in ms)
; =============================================================================
; UK: Double ring (400+450Hz, ring-ring pattern)
; Netherlands: Single long ring (425Hz)
; Germany: Single ring (425Hz, longer)
; France: Long ring (440Hz)
; Spain: Long ring (425Hz)
; Italy: Long ring (425Hz, distinctive pattern)
; Poland: Long ring (425Hz)
; US/Default: Single ring (440+480Hz)

; =============================================================================
; CONFIGURATION - Change this to your SIP endpoint for monitoring
; =============================================================================
; Set MONITOR_ENDPOINT to your SIP device (e.g., PJSIP/my-phone, PJSIP/1000)
; Set MONITOR_ENABLED=1 to ring your phone, 0 to skip monitoring
; =============================================================================

; =============================================================================
; INCOMING WHATSAPP/META CALLS - Forward to Python AudioSocket Bridge
; WhatsApp uses Opus natively, so we keep Opus end-to-end for best quality
; =============================================================================
[from-whatsapp]
exten => _+X.,1,NoOp(Incoming WhatsApp Call from: ${CALLERID(num)})
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 
 ; --- MONITOR CONFIGURATION ---
 same => n,Set(MONITOR_ENABLED=1)
 same => n,Set(MONITOR_ENDPOINT=PJSIP/my-phone)
 same => n,Set(MONITOR_TIMEOUT=15)
 
 ; Detect country from caller ID for ring tone
 same => n,Set(CALLER_NUM=${CALLERID(num)})
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+44"]?ring_uk)
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+31"]?ring_nl)
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+49"]?ring_de)
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+33"]?ring_fr)
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+34"]?ring_es)
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+39"]?ring_it)
 same => n,GotoIf($["${CALLER_NUM:0:3}" = "+48"]?ring_pl)
 same => n,GotoIf($["${CALLER_NUM:0:2}" = "+1"]?ring_us)
 same => n,Goto(ring_default)
 
 ; UK: Double ring (ring-ring, pause) - 400+450Hz
 same => n(ring_uk),NoOp(Playing UK ring tone)
 same => n,Playtones(400+450/400,0/200,400+450/400,0/2000)
 same => n,Goto(continue_call)
 
 ; Netherlands: Single long ring - 425Hz
 same => n(ring_nl),NoOp(Playing Netherlands ring tone)
 same => n,Playtones(425/1000,0/4000)
 same => n,Goto(continue_call)
 
 ; Germany: Single ring - 425Hz (similar to NL but different timing)
 same => n(ring_de),NoOp(Playing Germany ring tone)
 same => n,Playtones(425/1000,0/4000)
 same => n,Goto(continue_call)
 
 ; France: Long ring - 440Hz
 same => n(ring_fr),NoOp(Playing France ring tone)
 same => n,Playtones(440/1500,0/3500)
 same => n,Goto(continue_call)
 
 ; Spain: Long ring - 425Hz
 same => n(ring_es),NoOp(Playing Spain ring tone)
 same => n,Playtones(425/1500,0/3000)
 same => n,Goto(continue_call)
 
 ; Italy: Distinctive ring - 425Hz
 same => n(ring_it),NoOp(Playing Italy ring tone)
 same => n,Playtones(425/1000,0/4000)
 same => n,Goto(continue_call)
 
 ; Poland: Long ring - 425Hz
 same => n(ring_pl),NoOp(Playing Poland ring tone)
 same => n,Playtones(425/1000,0/4000)
 same => n,Goto(continue_call)
 
 ; US: Standard ring - 440+480Hz
 same => n(ring_us),NoOp(Playing US ring tone)
 same => n,Playtones(440+480/2000,0/4000)
 same => n,Goto(continue_call)
 
 ; Default: US-style ring
 same => n(ring_default),NoOp(Playing default ring tone)
 same => n,Playtones(440+480/2000,0/4000)
 same => n,Goto(continue_call)
 
 ; Continue after 2 seconds of ringing (for caller's benefit)
 same => n(continue_call),Wait(2)
 same => n,StopPlaytones()
 
 ; --- RING MONITOR PHONE FIRST (if enabled) ---
 ; This rings your SIP phone; when you answer, you'll hear the AI conversation
 same => n,GotoIf($["${MONITOR_ENABLED}" != "1"]?skip_monitor)
 same => n,NoOp(Ringing monitor phone: ${MONITOR_ENDPOINT})
 same => n,Dial(${MONITOR_ENDPOINT},${MONITOR_TIMEOUT},A(beep))
 same => n(skip_monitor),NoOp(Continuing to AI bridge)
 
 ; --- SET AUDIO FORMAT (Opus for WhatsApp native quality) ---
 ; WhatsApp uses Opus natively at 48kHz, keeping it end-to-end avoids transcoding loss
 ; Fallback: if Opus isn't available, Asterisk will use next best codec
 same => n,Set(CHANNEL(audioreadformat)=opus)
 same => n,Set(CHANNEL(audiowriteformat)=opus)
 
 same => n,Answer()
 
 ; Re-apply after answer to ensure it sticks
 same => n,Set(CHANNEL(audioreadformat)=opus)
 same => n,Set(CHANNEL(audiowriteformat)=opus)
 same => n,Wait(0.3)
 
 ; --- UUID GENERATION from caller phone number ---
 same => n,Set(CLEAN_NR=${FILTER(0-9,${CALLERID(num)})})
 same => n,Set(PADDED_NR=000000000000${CLEAN_NR})
 same => n,Set(SHORT_NR=${PADDED_NR:-12})
 same => n,Set(MY_UUID=00000000-0000-0000-0000-${SHORT_NR})
 
 same => n,AudioSocket(${MY_UUID},127.0.0.1:9092)
 same => n,Hangup()

; =============================================================================
; HANGUP HANDLER
; =============================================================================
[handler]
exten => cleanup,1,NoOp(Cleaning up call)
 same => n,Return()

; =============================================================================
; INTERNAL TEST CALLS (Dial 100 from SIP phone)
; =============================================================================
[from-internal]
exten => 100,1,NoOp(Internal Test Call to Ada)
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 ; Default to UK ring tone for internal tests
 same => n,Playtones(400+450/400,0/200,400+450/400,0/2000)
 same => n,Wait(2)
 ; Use Opus for best quality (matches WhatsApp path)
 same => n,Set(CHANNEL(audioreadformat)=opus)
 same => n,Set(CHANNEL(audiowriteformat)=opus)
 same => n,Answer()
 same => n,StopPlaytones()
 same => n,AudioSocket(00000000-0000-0000-0000-000000000100,127.0.0.1:9092)
 same => n,Hangup()

; =============================================================================
; DIRECT MONITOR DIAL-IN (Dial 101 to spy on active calls)
; =============================================================================
[from-internal]
exten => 101,1,NoOp(Monitor Mode - Listening to active calls)
 same => n,Answer()
 same => n,Wait(0.5)
 ; ChanSpy options: q=quiet (no beeps), W=can whisper to bridged channel
 same => n,ChanSpy(,qW)
 same => n,Hangup()
