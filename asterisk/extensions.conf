[general]
static=yes
writeprotect=no

; =============================================================================
; HD AUDIO ROUTING: WhatsApp â†’ C# SIP Bridge (bypasses 8kHz AudioSocket)
; =============================================================================
; The C# bridge (max201@{BRIDGE_IP}:5060) handles Opus/G.722 natively,
; preserving 48kHz/16kHz audio quality for superior STT accuracy.
; =============================================================================

[from-whatsapp]
; OPTION 1: Forward to C# SIP Bridge for HD audio (RECOMMENDED)
; Replace YOUR_BRIDGE_IP with the IP of your C# TaxiSipBridge
exten => _+X.,1,NoOp(HD WhatsApp Call from: ${CALLERID(num)})
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 ; Forward to C# Bridge - preserves Opus/G.722 codec
 ; NOTE: Update max201@YOUR_BRIDGE_IP to match your C# bridge registration
 same => n,Dial(PJSIP/max201,,g)
 same => n,Hangup()

; OPTION 2: Fallback to AudioSocket (16kHz - improved quality)
; Uncomment below and comment out OPTION 1 to use the Python bridge instead
; IMPORTANT: Forces slin16 (16kHz) to prevent codec oscillation during the call
; exten => _+X.,1,NoOp(16kHz AudioSocket Call from: ${CALLERID(num)})
;  same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
;  same => n,Answer()
;  same => n,Wait(0.3)
;  same => n,Set(CHANNEL(audioreadformat)=slin16)
;  same => n,Set(CHANNEL(audiowriteformat)=slin16)
;  same => n,Set(CLEAN_NR=${FILTER(0-9,${CALLERID(num)})})
;  same => n,Set(PADDED_NR=000000000000${CLEAN_NR})
;  same => n,Set(SHORT_NR=${PADDED_NR:-12})
;  same => n,Set(MY_UUID=00000000-0000-0000-0000-${SHORT_NR})
;  same => n,AudioSocket(${MY_UUID},127.0.0.1:9092)
;  same => n,Hangup()

[handler]
exten => cleanup,1,NoOp(Cleaning up call)
 same => n,Return()

[from-internal]
exten => 100,1,NoOp(Test Call to Ada)
 same => n,Answer()
 same => n,Set(CHANNEL(audioreadformat)=slin16)
 same => n,Set(CHANNEL(audiowriteformat)=slin16)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000100,127.0.0.1:9092)
 same => n,Hangup()

exten => 101,1,NoOp(Monitor Mode)
 same => n,Answer()
 same => n,ChanSpy(,qW)
 same => n,Hangup()
