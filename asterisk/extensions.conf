; =============================================================================
; Taxi AI - Asterisk Extensions Configuration
; Compatible with Asterisk 20.6+ (Strict UUID validation)
; =============================================================================

[general]
static=yes
writeprotect=no

; =============================================================================
; INCOMING WHATSAPP/META CALLS
; =============================================================================
[from-whatsapp]
exten => _+X.,1,NoOp(Incoming WhatsApp Call from: ${CALLERID(num)})
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 same => n,Answer()
 same => n,Progress()
 same => n,Wait(1)
 
 ; Clean phone number to digits only
 same => n,Set(CLEAN_NR=${FILTER(0-9,${CALLERID(num)})})
 
 ; Get last 12 digits (UUID final segment requirement)
 same => n,Set(PADDED_NR=${CLEAN_NR:-12})
 
 ; Build valid UUID: 00000000-0000-0000-0000-PHONE12DIGITS
 same => n,Set(MY_UUID=00000000-0000-0000-0000-${PADDED_NR})
 same => n,NoOp(Connecting to AI Bridge with UUID: ${MY_UUID})
 
 ; Connect to Python bridge
 same => n,AudioSocket(${MY_UUID},127.0.0.1:9092)
 same => n,Hangup()

; =============================================================================
; INTERNAL TEST CALLS (Dial 100 from SIP phone)
; =============================================================================
[from-internal]
exten => 100,1,NoOp(Internal Test Call to AI)
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 same => n,Answer()
 same => n,Progress()
 same => n,Wait(1)
 same => n,AudioSocket(00000000-0000-0000-0000-000000000100,127.0.0.1:9092)
 same => n,Hangup()

; Standard Asterisk test extension
exten => 200,1,Answer()
 same => n,Playback(demo-congrats)
 same => n,Hangup()

; =============================================================================
; HANGUP HANDLER
; =============================================================================
[handler]
exten => cleanup,1,NoOp(Call ended for ${CLEAN_NR})
 same => n,Return()

; =============================================================================
; OUTBOUND DIALING (if needed)
; =============================================================================
[from-outbound]
exten => _X.,1,Dial(PJSIP/whatsapp-out/sip:${EXTEN}@wa.meta.vc)
