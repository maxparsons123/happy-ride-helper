; =============================================================================
; Taxi AI - Asterisk Extensions Configuration
; Compatible with Asterisk 20.6+
; =============================================================================

[general]
static=yes
writeprotect=no

; =============================================================================
; INCOMING WHATSAPP/META CALLS
; =============================================================================
[from-whatsapp]
exten => _+X.,1,NoOp(Incoming WhatsApp Call from: ${CALLERID(num)})
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 same => n,Answer()
 same => n,Progress()
 same => n,Wait(1)
 
 ; 1. Prepare a 12-digit version of the phone number
 same => n,Set(CLEAN_NR=${FILTER(0-9,${CALLERID(num)})})
 ; Take the last 12 digits to ensure it fits the expected UUID node length
 same => n,Set(SHORT_NR=${CLEAN_NR:-12})
 
 ; 2. Create a CLEAN 32-character Hex UUID (NO DASHES)
 ; This ensures the Python bridge reads the header bytes correctly
 same => n,Set(MY_UUID=00000000000000000000${SHORT_NR})
 same => n,NoOp(Sending Validated UUID: ${MY_UUID})
 
 ; 3. Connect to the Python Bridge
 same => n,AudioSocket(${MY_UUID},127.0.0.1:9092)
 same => n,Hangup()

; =============================================================================
; HANGUP HANDLER
; =============================================================================
[handler]
exten => cleanup,1,NoOp(Cleaning up AI Socket)
 same => n,Return()

; =============================================================================
; INTERNAL TEST CALLS (Dial 100 from SIP phone)
; =============================================================================
[from-internal]
exten => 100,1,NoOp(Internal Test Call)
 same => n,Set(CHANNEL(hangup_handler_push)=handler,cleanup,1)
 same => n,Answer()
 same => n,Progress()
 same => n,Wait(1)
 ; Clean 32-character UUID for internal testing
 same => n,AudioSocket(00000000000000000000000000000100,127.0.0.1:9092)
 same => n,Hangup()