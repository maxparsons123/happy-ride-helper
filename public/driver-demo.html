<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Black Cab Unite ‚Äî Driver Tablet App</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/mqtt@4.3.8/dist/mqtt.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  :root{
    --gold:#FFD700;--gold-dark:#D4A800;--bg:#0a0a0a;--panel:#111;--card:#1a1a1a;
    --card-hover:#222;--text:#eee;--muted:#888;--green:#22c55e;--red:#ef4444;
    --blue:#3b82f6;--orange:#f59e0b;--cyan:#06b6d4;
  }
  body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh}

  /* TOP BAR */
  .topbar{display:flex;align-items:center;justify-content:space-between;padding:8px 16px;background:linear-gradient(90deg,#000,#1a1a1a);border-bottom:2px solid var(--gold);height:52px;z-index:10}
  .topbar .brand{display:flex;align-items:center;gap:8px;font-weight:800;color:var(--gold);font-size:16px}
  .topbar .status-group{display:flex;align-items:center;gap:16px;font-size:13px}
  .status-pill{padding:4px 12px;border-radius:20px;font-weight:700;font-size:12px;display:flex;align-items:center;gap:6px}
  .status-pill .dot{width:8px;height:8px;border-radius:50%;display:inline-block}
  .status-online .dot{background:var(--green);box-shadow:0 0 8px rgba(34,197,94,.7)}
  .status-online{background:rgba(34,197,94,.15);color:var(--green)}
  .mqtt-pill{background:rgba(6,182,212,.12);color:var(--cyan)}
  .mqtt-pill .dot{background:var(--cyan);box-shadow:0 0 8px rgba(6,182,212,.7)}
  .earnings{color:var(--gold);font-weight:700}

  /* MAIN SPLIT */
  .main{display:flex;height:calc(100vh - 52px)}
  .left-panel{width:35%;min-width:320px;max-width:420px;display:flex;flex-direction:column;background:var(--panel);border-right:1px solid #222;overflow:hidden}
  .right-panel{flex:1;position:relative}

  /* TABS */
  .tabs{display:flex;border-bottom:1px solid #333}
  .tab{flex:1;padding:10px;text-align:center;font-weight:700;font-size:13px;cursor:pointer;color:var(--muted);border-bottom:2px solid transparent;transition:.2s}
  .tab.active{color:var(--gold);border-bottom-color:var(--gold)}
  .tab .badge{background:var(--gold);color:#000;border-radius:10px;padding:1px 7px;font-size:11px;margin-left:4px}

  /* JOB LIST */
  .job-list{flex:1;overflow-y:auto;padding:8px}
  .job-list::-webkit-scrollbar{width:4px}
  .job-list::-webkit-scrollbar-thumb{background:#333;border-radius:2px}

  /* JOB CARD */
  .job-card{background:var(--card);border:1px solid #2a2a2a;border-radius:10px;padding:12px;margin-bottom:8px;cursor:pointer;transition:.15s}
  .job-card:hover{background:var(--card-hover);border-color:#444}
  .job-card.selected{border-color:var(--gold);box-shadow:0 0 0 1px var(--gold)}
  .job-card.bid-pending{opacity:.7}
  .job-card.bid-won{border-color:var(--green);background:rgba(34,197,94,.08)}

  .jc-top{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:6px}
  .jc-pickup{font-weight:700;font-size:14px;display:flex;align-items:center;gap:4px}
  .jc-pickup::before{content:'üìç';font-size:12px}
  .jc-dist{font-weight:800;font-size:18px;color:var(--gold);white-space:nowrap}
  .jc-dist small{font-size:11px;color:var(--muted);font-weight:400}

  .jc-dropoff{font-size:13px;color:var(--muted);margin-bottom:4px;display:flex;align-items:center;gap:4px}
  .jc-dropoff::before{content:'üèÅ';font-size:11px}
  .jc-meta{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px;font-size:12px}
  .jc-meta span{background:#222;padding:2px 8px;border-radius:6px}
  .jc-fare{color:var(--green);font-weight:700}
  .jc-time{color:var(--cyan)}
  .jc-notes{font-size:12px;color:var(--orange);margin-bottom:8px}

  .jc-tags{display:flex;gap:4px;margin-bottom:8px}
  .tag{font-size:10px;padding:2px 6px;border-radius:4px;font-weight:600}
  .tag-asap{background:rgba(239,68,68,.2);color:var(--red)}
  .tag-airport{background:rgba(59,130,246,.2);color:var(--blue)}
  .tag-wheelchair{background:rgba(245,158,11,.2);color:var(--orange)}

  .jc-actions{display:flex;gap:6px}
  .btn{padding:8px 16px;border:none;border-radius:8px;font-weight:700;font-size:13px;cursor:pointer;transition:.15s;display:flex;align-items:center;gap:4px}
  .btn:active{transform:scale(.95)}
  .btn-bid{background:var(--gold);color:#000;flex:1;justify-content:center}
  .btn-bid:hover{background:var(--gold-dark)}
  .btn-bid:disabled{opacity:.5;cursor:not-allowed}
  .btn-preview{background:#222;color:var(--text)}
  .btn-connect{background:#222;color:var(--cyan)}
  .card-connectors{margin-top:8px;border-top:1px solid #333;padding-top:8px}
  .conn-mini{background:#111;border:1px solid #2a2a2a;border-radius:6px;padding:6px 8px;margin-bottom:4px;cursor:pointer;transition:.15s}
  .conn-mini:hover{border-color:var(--cyan);background:#1a1a1a}

  /* CONNECTING JOBS */
  .connectors-section{margin-top:12px;border:1px solid #333;border-radius:10px;padding:10px;background:rgba(6,182,212,.05)}
  .connectors-title{font-size:13px;font-weight:700;color:var(--cyan);margin-bottom:8px;display:flex;align-items:center;gap:6px}
  .conn-card{background:#1a1a1a;border:1px solid #333;border-radius:8px;padding:8px 10px;margin-bottom:6px;cursor:pointer;transition:.15s}
  .conn-card:hover{border-color:var(--cyan)}
  .conn-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
  .conn-pickup{font-size:12px;font-weight:600;color:var(--text)}
  .conn-dist{font-size:11px;color:var(--cyan);font-weight:700}
  .conn-dropoff{font-size:11px;color:var(--muted);margin-bottom:4px}
  .conn-meta{display:flex;gap:6px;align-items:center;font-size:11px}
  .conn-fare{color:var(--green);font-weight:700}
  .conn-savings{color:var(--gold);font-weight:700;font-size:10px;background:rgba(255,215,0,.15);padding:1px 6px;border-radius:4px}
  .conn-bid{padding:4px 12px;border:none;border-radius:6px;background:var(--gold);color:#000;font-weight:700;font-size:11px;cursor:pointer}
  .conn-bid:disabled{opacity:.5;cursor:not-allowed}

  /* INBOX DETAIL */
  .inbox-detail{display:none;flex-direction:column;height:100%;padding:10px;overflow-y:auto}
  .inbox-detail.visible{display:flex}
  .inbox-back{color:var(--gold);cursor:pointer;font-size:13px;margin-bottom:6px;font-weight:600}

  .id-header{margin-bottom:8px}
  .id-header h3{font-size:14px;margin-bottom:2px}
  .id-passenger{font-size:12px;color:var(--muted)}

  .timeline{display:flex;flex-direction:column;gap:0;padding:10px 0 10px 16px;position:relative}
  .tl-step{display:flex;align-items:center;gap:10px;padding:6px 0;position:relative}
  .tl-step::before{content:'';position:absolute;left:4px;top:-6px;height:calc(100% + 0px);width:2px;background:#333;z-index:0}
  .tl-step:first-child::before{top:50%;height:50%}
  .tl-step:last-child::before{height:50%}
  .tl-step.done::before{background:var(--green)}
  .tl-step.current::before{background:linear-gradient(to bottom,var(--green),var(--gold))}
  .tl-dot{width:12px;height:12px;border-radius:50%;border:2px solid #555;flex-shrink:0;position:relative;z-index:1;background:var(--bg)}
  .tl-step.done .tl-dot{background:var(--green);border-color:var(--green)}
  .tl-step.current .tl-dot{background:var(--gold);border-color:var(--gold);box-shadow:0 0 10px rgba(255,215,0,.6)}
  .tl-label{font-size:13px;color:var(--muted)}
  .tl-step.current .tl-label{color:var(--text);font-weight:700;font-size:14px}
  .tl-step.done .tl-label{color:var(--green)}
  .tl-connector{display:none}

  .primary-action{padding:12px;border-radius:10px;background:var(--gold);color:#000;font-weight:800;font-size:15px;border:none;cursor:pointer;width:100%;margin-top:6px;transition:.15s;flex-shrink:0}
  .primary-action:active{transform:scale(.97)}

  .secondary-actions{display:flex;gap:6px;margin-top:6px;flex-shrink:0}
  .btn-secondary{flex:1;padding:8px;border-radius:8px;border:1px solid #333;background:transparent;color:var(--text);font-weight:600;font-size:12px;cursor:pointer}
  .btn-msg{border-color:var(--cyan);color:var(--cyan)}
  .btn-cancel{border-color:var(--red);color:var(--red)}

  /* MESSAGE PANEL */
  .msg-panel{display:none;background:var(--card);border:1px solid var(--cyan);border-radius:10px;padding:10px;margin-top:8px;flex-shrink:0}
  .msg-panel.visible{display:block}
  .msg-presets{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .msg-preset{padding:8px 12px;border-radius:20px;border:1px solid #444;background:#222;color:var(--text);font-size:12px;cursor:pointer;transition:.15s}
  .msg-preset:hover{border-color:var(--cyan);color:var(--cyan)}
  .msg-thread{max-height:120px;overflow-y:auto;margin-top:8px}
  .msg-bubble{padding:6px 10px;border-radius:8px;margin-bottom:4px;font-size:12px;max-width:80%}
  .msg-driver{background:rgba(6,182,212,.15);color:var(--cyan);margin-left:auto}
  .msg-pax{background:#222;color:var(--text)}

  /* CONNECTING JOBS */
  .connectors{margin-top:12px;border-top:1px solid #333;padding-top:8px}
  .connectors h4{font-size:12px;color:var(--muted);margin-bottom:6px}
  .conn-card{background:#1e1e1e;border:1px solid #2a2a2a;border-radius:8px;padding:8px;margin-bottom:4px;font-size:12px}
  .conn-card .cc-dist{color:var(--gold);font-weight:700}

  /* MAP OVERLAY ELEMENTS */
  .map-info{position:absolute;top:8px;right:8px;z-index:800;background:rgba(0,0,0,.8);color:var(--text);padding:8px 14px;border-radius:8px;font-size:12px;backdrop-filter:blur(4px);pointer-events:none}

  /* TOAST */
  .toast-container{position:fixed;top:60px;right:16px;z-index:9999;display:flex;flex-direction:column;gap:6px}
  .toast{padding:10px 16px;border-radius:8px;font-size:13px;font-weight:600;animation:slideIn .3s ease;box-shadow:0 4px 16px rgba(0,0,0,.5)}
  .toast-success{background:rgba(34,197,94,.9);color:#fff}
  .toast-error{background:rgba(239,68,68,.9);color:#fff}
  .toast-info{background:rgba(59,130,246,.9);color:#fff}
  @keyframes slideIn{from{transform:translateX(100px);opacity:0}to{transform:translateX(0);opacity:1}}

  /* EMPTY STATE */
  .empty-state{text-align:center;padding:40px 20px;color:var(--muted)}
  .empty-state .icon{font-size:48px;margin-bottom:12px}

  /* COMPLETION MODAL */
  .modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:9000;align-items:center;justify-content:center}
  .modal-overlay.visible{display:flex}
  .modal{background:var(--card);border:1px solid #333;border-radius:16px;padding:24px;max-width:400px;width:90%;text-align:center}
  .modal h2{color:var(--gold);margin-bottom:12px}
  .modal .summary{text-align:left;font-size:13px;margin:16px 0}
  .modal .summary div{display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid #222}
</style>
</head>
<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="brand">üöï Black Cab Unite ‚Äî <span id="driverIdLabel" style="font-size:12px;color:#aaa;font-weight:400"></span></div>
  <div class="status-group">
    <div class="status-pill status-online" id="driverStatus" style="cursor:pointer" onclick="cycleDriverStatus()"><span class="dot"></span> <span id="statusText">Online</span></div>
    <div class="status-pill mqtt-pill" id="mqttPill"><span class="dot"></span> <span id="mqttText">MQTT Connecting‚Ä¶</span></div>
    <div class="status-pill" style="cursor:pointer" onclick="toggleTTS()" id="ttsPill">üîä TTS On</div>
    <div class="earnings">Today: ¬£<span id="earningsTotal">0.00</span></div>
  </div>
</div>

<!-- MAIN SPLIT -->
<div class="main">
  <!-- LEFT PANEL -->
  <div class="left-panel">
    <div class="tabs">
      <div class="tab active" id="tabAvail" onclick="switchTab('available')">Available <span class="badge" id="availCount">0</span></div>
      <div class="tab" id="tabInbox" onclick="switchTab('inbox')">Inbox <span class="badge" id="inboxCount">0</span></div>
      <div class="tab" id="tabHistory" onclick="switchTab('history')">History</div>
    </div>

    <!-- Available Jobs List -->
    <div class="job-list" id="availableList"></div>

    <!-- Inbox Detail -->
    <div class="inbox-detail" id="inboxDetail"></div>

    <!-- History -->
    <div class="job-list" id="historyList" style="display:none">
      <div class="empty-state"><div class="icon">üìã</div>No completed jobs yet</div>
    </div>
  </div>

  <!-- RIGHT PANEL (MAP) -->
  <div class="right-panel">
    <div id="map" style="width:100%;height:100%"></div>
    <div class="map-info" id="mapInfo">Driver location ‚Äî Coventry</div>
  </div>
</div>

<!-- TOAST CONTAINER -->
<div class="toast-container" id="toasts"></div>

<!-- COMPLETION MODAL -->
<div class="modal-overlay" id="completionModal">
  <div class="modal">
    <h2>‚úÖ Job Completed</h2>
    <div class="summary" id="completionSummary"></div>
    <button class="primary-action" onclick="closeCompletion()">Back to Available Jobs</button>
  </div>
</div>

<!-- Debug log visible on screen -->
<div id="debugLog" style="position:fixed;bottom:0;left:0;right:0;z-index:99999;background:rgba(0,0,0,0.9);color:#0f0;font-family:monospace;font-size:11px;max-height:150px;overflow-y:auto;padding:4px 8px;display:none;"></div>

<script src="driver-demo.js"></script>